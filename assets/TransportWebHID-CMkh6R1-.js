import{g as R,y as A,b as g,i as j,z as T,A as L,D as X,B as P,C as H,F as V,G as $}from"./index-3az5FYUj.js";var C={};const G=R(A);(function(a){a.__esModule=!0;var r=G,e=5;function n(c){var l=g.Buffer.alloc(2);return l.writeUInt16BE(c,0),l}var i={data:g.Buffer.alloc(0),dataLength:0,sequence:0},t=function(c,l){return{makeBlocks:function(u){var o=g.Buffer.concat([n(u.length),u]),s=l-5,d=Math.ceil(o.length/s);o=g.Buffer.concat([o,g.Buffer.alloc(d*s-o.length+1).fill(0)]);for(var h=[],v=0;v<d;v++){var p=g.Buffer.alloc(5);p.writeUInt16BE(c,0),p.writeUInt8(e,2),p.writeUInt16BE(v,3);var w=o.slice(v*s,(v+1)*s);h.push(g.Buffer.concat([p,w]))}return h},reduceResponse:function(u,o){var s=u||i,d=s.data,h=s.dataLength,v=s.sequence;if(o.readUInt16BE(0)!==c)throw new r.TransportError("Invalid channel","InvalidChannel");if(o.readUInt8(2)!==e)throw new r.TransportError("Invalid tag","InvalidTag");if(o.readUInt16BE(3)!==v)throw new r.TransportError("Invalid sequence","InvalidSequence");u||(h=o.readUInt16BE(5)),v++;var p=o.slice(u?5:7);return d=g.Buffer.concat([d,p]),d.length>h&&(d=d.slice(0,h)),{data:d,dataLength:h,sequence:v}},getReducedResult:function(u){if(u&&u.dataLength===u.data.length)return u.data}}};a.default=t})(C);const W=j(C);var U=function(){return U=Object.assign||function(a){for(var r,e=1,n=arguments.length;e<n;e++){r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(a[i]=r[i])}return a},U.apply(this,arguments)},b,f;(function(a){a.blue="blue",a.nanoS="nanoS",a.nanoSP="nanoSP",a.nanoX="nanoX",a.nanoFTS="nanoFTS"})(f||(f={}));var k=(b={},b[f.blue]={id:f.blue,productName:"Ledger Blue",productIdMM:0,legacyUsbProductId:0,usbOnly:!0,memorySize:480*1024,masks:[822083584,822149120],getBlockSize:function(a){return 4*1024}},b[f.nanoS]={id:f.nanoS,productName:"Ledger Nano S",productIdMM:16,legacyUsbProductId:1,usbOnly:!0,memorySize:320*1024,masks:[823132160],getBlockSize:function(a){var r;return T.lt((r=T.coerce(a))!==null&&r!==void 0?r:"","2.0.0")?4*1024:2*1024}},b[f.nanoSP]={id:f.nanoSP,productName:"Ledger Nano S Plus",productIdMM:80,legacyUsbProductId:5,usbOnly:!0,memorySize:1536*1024,masks:[856686592],getBlockSize:function(a){return 32}},b[f.nanoX]={id:f.nanoX,productName:"Ledger Nano X",productIdMM:64,legacyUsbProductId:4,usbOnly:!1,memorySize:2*1024*1024,masks:[855638016],getBlockSize:function(a){return 4*1024},bluetoothSpec:[{serviceUuid:"13d63400-2c97-0004-0000-4c6564676572",notifyUuid:"13d63400-2c97-0004-0001-4c6564676572",writeUuid:"13d63400-2c97-0004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-0004-0003-4c6564676572"}]},b[f.nanoFTS]={id:f.nanoFTS,productName:"Ledger Nano FTS",productIdMM:96,legacyUsbProductId:6,usbOnly:!1,memorySize:2*1024*1024,masks:[857735168],getBlockSize:function(a){return 4*1024},bluetoothSpec:[{serviceUuid:"13d63400-2c97-6004-0000-4c6564676572",notifyUuid:"13d63400-2c97-6004-0001-4c6564676572",writeUuid:"13d63400-2c97-6004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-6004-0003-4c6564676572"}]},b);f.blue,f.nanoS,f.nanoSP,f.nanoX,f.nanoFTS;var M=Object.values(k),F=11415,O=function(a){var r=M.find(function(i){return i.legacyUsbProductId===a});if(r)return r;var e=a>>8,n=M.find(function(i){return i.productIdMM===e});return n},K=[],z={};for(var J in k){var N=k[J],_=N.bluetoothSpec;if(_)for(var B=0;B<_.length;B++){var I=_[B];K.push(I.serviceUuid),z[I.serviceUuid]=z[I.serviceUuid.replace(/-/g,"")]=U({deviceModel:N},I)}}var Q=function(){var a=function(r,e){return a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(n[t]=i[t])},a(r,e)};return function(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");a(r,e);function n(){this.constructor=r}r.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}}(),m=function(a,r,e,n){function i(t){return t instanceof e?t:new e(function(c){c(t)})}return new(e||(e=Promise))(function(t,c){function l(s){try{o(n.next(s))}catch(d){c(d)}}function u(s){try{o(n.throw(s))}catch(d){c(d)}}function o(s){s.done?t(s.value):i(s.value).then(l,u)}o((n=n.apply(a,r||[])).next())})},y=function(a,r){var e={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},n,i,t,c;return c={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function l(o){return function(s){return u([o,s])}}function u(o){if(n)throw new TypeError("Generator is already executing.");for(;e;)try{if(n=1,i&&(t=o[0]&2?i.return:o[0]?i.throw||((t=i.return)&&t.call(i),0):i.next)&&!(t=t.call(i,o[1])).done)return t;switch(i=0,t&&(o=[o[0]&2,t.value]),o[0]){case 0:case 1:t=o;break;case 4:return e.label++,{value:o[1],done:!1};case 5:e.label++,i=o[1],o=[0];continue;case 7:o=e.ops.pop(),e.trys.pop();continue;default:if(t=e.trys,!(t=t.length>0&&t[t.length-1])&&(o[0]===6||o[0]===2)){e=0;continue}if(o[0]===3&&(!t||o[1]>t[0]&&o[1]<t[3])){e.label=o[1];break}if(o[0]===6&&e.label<t[1]){e.label=t[1],t=o;break}if(t&&e.label<t[2]){e.label=t[2],e.ops.push(o);break}t[2]&&e.ops.pop(),e.trys.pop();continue}o=r.call(a,e)}catch(s){o=[6,s],i=0}finally{n=t=0}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}},Y=function(a,r){var e=typeof Symbol=="function"&&a[Symbol.iterator];if(!e)return a;var n=e.call(a),i,t=[],c;try{for(;(r===void 0||r-- >0)&&!(i=n.next()).done;)t.push(i.value)}catch(l){c={error:l}}finally{try{i&&!i.done&&(e=n.return)&&e.call(n)}finally{if(c)throw c.error}}return t},Z=[{vendorId:F}],ee=function(){return Promise.resolve(!!(window.navigator&&window.navigator.hid))},x=function(){var a=navigator.hid;if(!a)throw new V("navigator.hid is not supported","HIDNotSupported");return a};function q(){return m(this,void 0,void 0,function(){var a;return y(this,function(r){switch(r.label){case 0:return[4,x().requestDevice({filters:Z})];case 1:return a=r.sent(),Array.isArray(a)?[2,a]:[2,[a]]}})})}function E(){return m(this,void 0,void 0,function(){var a;return y(this,function(r){switch(r.label){case 0:return[4,x().getDevices()];case 1:return a=r.sent(),[2,a.filter(function(e){return e.vendorId===F})]}})})}function ne(){return m(this,void 0,void 0,function(){var a,r;return y(this,function(e){switch(e.label){case 0:return[4,E()];case 1:return a=e.sent(),a.length>0?[2,a[0]]:[4,q()];case 2:return r=e.sent(),[2,r[0]]}})})}var re=function(a){Q(r,a);function r(e){var n=a.call(this)||this;return n.channel=Math.floor(Math.random()*65535),n.packetSize=64,n.inputs=[],n.read=function(){return n.inputs.length?Promise.resolve(n.inputs.shift()):new Promise(function(i){n.inputCallback=i})},n.onInputReport=function(i){var t=g.Buffer.from(i.data.buffer);n.inputCallback?(n.inputCallback(t),n.inputCallback=null):n.inputs.push(t)},n._disconnectEmitted=!1,n._emitDisconnect=function(i){n._disconnectEmitted||(n._disconnectEmitted=!0,n.emit("disconnect",i))},n.exchange=function(i){return m(n,void 0,void 0,function(){var t,c=this;return y(this,function(l){switch(l.label){case 0:return[4,this.exchangeAtomicImpl(function(){return m(c,void 0,void 0,function(){var u,o,s,d,h,v,p,w,D;return y(this,function(S){switch(S.label){case 0:u=this,o=u.channel,s=u.packetSize,L("apdu","=> "+i.toString("hex")),d=W(o,s),h=d.makeBlocks(i),v=0,S.label=1;case 1:return v<h.length?[4,this.device.sendReport(0,h[v])]:[3,4];case 2:S.sent(),S.label=3;case 3:return v++,[3,1];case 4:return(p=d.getReducedResult(w))?[3,6]:[4,this.read()];case 5:return D=S.sent(),w=d.reduceResponse(w,D),[3,4];case 6:return L("apdu","<= "+p.toString("hex")),[2,p]}})})}).catch(function(u){throw u&&u.message&&u.message.includes("write")?(c._emitDisconnect(u),new X(u.message)):u})];case 1:return t=l.sent(),[2,t]}})})},n.device=e,n.deviceModel=typeof e.productId=="number"?O(e.productId):void 0,e.addEventListener("inputreport",n.onInputReport),n}return r.request=function(){return m(this,void 0,void 0,function(){var e,n;return y(this,function(i){switch(i.label){case 0:return[4,q()];case 1:return e=Y.apply(void 0,[i.sent(),1]),n=e[0],[2,r.open(n)]}})})},r.openConnected=function(){return m(this,void 0,void 0,function(){var e;return y(this,function(n){switch(n.label){case 0:return[4,E()];case 1:return e=n.sent(),e.length===0?[2,null]:[2,r.open(e[0])]}})})},r.open=function(e){return m(this,void 0,void 0,function(){var n,i;return y(this,function(t){switch(t.label){case 0:return[4,e.open()];case 1:return t.sent(),n=new r(e),i=function(c){e===c.device&&(x().removeEventListener("disconnect",i),n._emitDisconnect(new $))},x().addEventListener("disconnect",i),[2,n]}})})},r.prototype.close=function(){return m(this,void 0,void 0,function(){return y(this,function(e){switch(e.label){case 0:return[4,this.exchangeBusyPromise];case 1:return e.sent(),this.device.removeEventListener("inputreport",this.onInputReport),[4,this.device.close()];case 2:return e.sent(),[2]}})})},r.prototype.setScrambleKey=function(){},r.isSupported=ee,r.list=E,r.listen=function(e){var n=!1;ne().then(function(t){if(!t)e.error(new P("Access denied to use Ledger device"));else if(!n){var c=typeof t.productId=="number"?O(t.productId):void 0;e.next({type:"add",descriptor:t,deviceModel:c}),e.complete()}},function(t){e.error(new P(t.message))});function i(){n=!0}return{unsubscribe:i}},r}(H);export{re as default};
